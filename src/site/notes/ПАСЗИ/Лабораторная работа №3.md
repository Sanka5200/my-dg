---
{"dg-publish":true,"permalink":"/paszi/laboratornaya-rabota-3/","noteIcon":""}
---

# AppArmor

---

**ФИО:** 2022-ФГиИБ-ИБ-1б Кубицкий Александр Андреевич

---
### 1. Проверка _complain_ и _enforce_ режимов

**1.1. Создайте копию утилиты `ping` (из директории `/bin/`), а вместо неё скопируйте утилиту `cp` (`/bin/cp -> /bin/ping`). После этого переведите профиль `bin.ping` в режим `enforce`. Создайте в домашней директории файл и попробуйте его скопировать с помощью утилиты `ping` (которая, по факту, является копией утилиты `cp`).**
![Pasted image 20250317114224.png](/img/user/Images/Pasted%20image%2020250317114224.png)
Объясните, что произошло. Посмотрите журнал, что там за сообщения (относительно этой операции), что они значат?
Мы не можем скопировать файл, так как режим `enforce` в `apparmor` гарантирует соблюдение правил (невозможность копирования из данной директории), записанных в файле профиля. Нарушения не допускаются, и соответствующая запись попадает в логи, что и произошло.

**1.2. Переведите профиль `bin.ping` в режим `complain`. Повторите действия из шага 1.1. Что изменилось? Объясните. Какие теперь записи в журнале?**
Нашли записи в `syslog` по слову `apparmor`
![Pasted image 20250317114851.png](/img/user/Images/Pasted%20image%2020250317114851.png)
Теперь, вместо того, чтобы `apparmor` **блокировал** запрещённые действия для утилиты `ping`, он **записывает** их в логи.

**1.3. Верните утилиту `ping` на своё место.**
![Pasted image 20250317115555.png](/img/user/Images/Pasted%20image%2020250317115555.png)

**1.4. Переведите профиль `bin.ping` в режим `enforce`. Попробуйте воспользоваться утилитой (из шага 1.1.) `my_ping`.**
![Pasted image 20250317120132.png](/img/user/Images/Pasted%20image%2020250317120132.png)
Объясните, что произошло. Посмотрите журнал, что там за сообщения (относительно этой операции)?
Так как утилита `ping` контролируется и защищается `apparmor`, она штатно работать не будет.
### 2. AppArmor на примере Docker

**2.1. Установите Docker**

[Установка Docker в Ubuntu](https://docs.docker.com/engine/install/ubuntu/)
В системе ранее уже был установлен `Docker`.
![Pasted image 20250317120539.png](/img/user/Images/Pasted%20image%2020250317120539.png)

Создайте группу `docker`, добавьте в неё своего пользователя. При необходимости перезагрузите систему.
![Pasted image 20250317121032.png](/img/user/Images/Pasted%20image%2020250317121032.png)
Спустя время добавляем пользователя `kubik` в группу `docker`.

**2.2. Создайте Docker-конетейнер с ubuntu:**
```
docker container run --rm -it --cap-add SYS_ADMIN --security-opt seccomp=unconfined ubuntu sh
```
![Pasted image 20250317122224.png](/img/user/Images/Pasted%20image%2020250317122224.png)
Что значат ключи: - `--cap-add` - `seccomp=unconfined`

`--cap-add` отвечает за выдачу разрешений контейнеру, а `seccomp=unconfined` - отметка что контейнер не имеет изоляции.

Какой профиль **AppArmor** загружен?
![Pasted image 20250317122338.png](/img/user/Images/Pasted%20image%2020250317122338.png)
![Pasted image 20250317124605.png](/img/user/Images/Pasted%20image%2020250317124605.png)
Профилей `apparmor` в контейнере нет, как и самого `apparmor`.

Создайте два новых каталога (внутри контейнера), смонтируйте первый каталог в другой каталог (подробнее, `mount --bind`)
![Pasted image 20250317124925.png](/img/user/Images/Pasted%20image%2020250317124925.png)
Что происходит?
`mount` не сработал, `dmesg` тоже, почитал информацию с помощью `--cap-add CAP_SYSLOG`, но ничего не нашёл.
### 3. Пользовательский профиль AppArmor

**3.1. Скачайте материалы для ЛР из репозитория Docker:**
```
git clone https://github.com/docker/labs.git
cd labs/security/apparmor/wordpress
```
![Pasted image 20250317130041.png](/img/user/Images/Pasted%20image%2020250317130041.png)

**3.2. Опишите, какие контейнеры предлагается создать (docker-compose.yml). Создайте контейнеры с помощью docker-compose**
Перепишем содержимое файла `docker-compose.yaml` с помощью `nano` и посмотрим на новое содержимое.
![Pasted image 20250317131624.png](/img/user/Images/Pasted%20image%2020250317131624.png)
![Pasted image 20250317133520.png](/img/user/Images/Pasted%20image%2020250317133520.png)

**3.3. Проверьте работоспособность WordPress, выбрав язык и установив какие-либо плагины.**
![Pasted image 20250317133737.png](/img/user/Images/Pasted%20image%2020250317133737.png)
**Все ли работает?**
Пришлось перезапустить контейнеры, чтобы всё заработало.
![Pasted image 20250317133939.png](/img/user/Images/Pasted%20image%2020250317133939.png)

**3.4. Удалите созданные контейнеры.**
![Pasted image 20250317134202.png](/img/user/Images/Pasted%20image%2020250317134202.png)

**3.5. Добавьте wparmor профиль в файл конфигурации.**
Вставляем:
```
security_opt:
    - apparmor=wparmor
```
![Pasted image 20250317135422.png](/img/user/Images/Pasted%20image%2020250317135422.png)

**3.6. Отредактируйте файл wparmor так, чтобы запретить использование каталогов в `var/www/html/wp-content` за исключением директории `uploads`. _Спарсите_ новый файл (`apparmor_parse`).**
![Pasted image 20250331111404.png](/img/user/Images/Pasted%20image%2020250331111404.png)

![Pasted image 20250331112456.png](/img/user/Images/Pasted%20image%2020250331112456.png)
**3.7. Повторите шаги 3.2. и 3.3. и опишите результат.**
Запустили докер
![Pasted image 20250331112553.png](/img/user/Images/Pasted%20image%2020250331112553.png)
**Можете ли вы устанавливать плагины и загружать другой контент?**
![Pasted image 20250331112814.png](/img/user/Images/Pasted%20image%2020250331112814.png)
Теперь для установки плагинов или загрузки контента требуется вводить дополнительные данные
### 4. Пользовательский профиль AppArmor произвольного приложения

**4.1. Выберите произвольное приложение с открытым исходным кодом (приложение может сразу поставляться в виде docker-образа или вы можете создать образ самостоятельно). Приложение должно быть подобрано таким образом, чтобы было удобно настроить политику AppArmor для него. Разверните приложение, опишите процесс выполнения развертывания.**
В качестве простейшего приложения было выбрано `nginx`, так как в нем удобно настраивать политику Apparmor
![Pasted image 20250331114010.png](/img/user/Images/Pasted%20image%2020250331114010.png)
Устанавливаем его последнюю версию

Запуск контейнера и вход в его оболочку.
![Pasted image 20250331114719.png](/img/user/Images/Pasted%20image%2020250331114719.png)

**4.2. Придумайте и опишите политику AppArmor, продемонстрируйте её работу.**
Например, мы хотим ограничить работу команды `cat`.  
Apparmor работает в режиме `default-deny` - всё, что не записано в профиль, будет отклоняться. Создания профиля для `echo` и его перевод в режим `aa-enforce` будет достаточно, чтобы он перестал работать.

![Pasted image 20250331122610.png](/img/user/Images/Pasted%20image%2020250331122610.png)

Воспользуемся шаблоном политики от самого докера для `nginx`, отредактируем его под свои нужды. В результате были убраны ограничение на запись в `/home` и ограничена запись в `/sys`.
![Pasted image 20250331123712.png](/img/user/Images/Pasted%20image%2020250331123712.png)

![Pasted image 20250331124902.png](/img/user/Images/Pasted%20image%2020250331124902.png)

![Pasted image 20250331125126.png](/img/user/Images/Pasted%20image%2020250331125126.png)

![Pasted image 20250331125444.png](/img/user/Images/Pasted%20image%2020250331125444.png)
Запись в `bin` недоступна, а в `home` получилось создать файл `my_file`, из чего можно сделать вывод, что политика работает корректно.